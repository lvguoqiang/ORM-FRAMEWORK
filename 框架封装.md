# ORM框架封装

> 参考MyBatis框架, 自己封装一个ORM框架

- 1.0

# 1.0 

> 1.0 版本仿照MyBatis提供了三个主要接口。主要是为了理解 MyBatis 框架封装的过程

- SqlSession

  > 提供获取Mapper实例和查询单条数据的接口。它的实现是通过委托模式，委托Configuration和Executor时间具体细节

  - `<T> T getMapper(Class<T> clazz)`
  - `<T> T selectOne(String sql, Object parameter)`

- Configuration

  > 提供获取Mapper实例

  - `<T> T getMapper(Class<T> clazz, SqlSession sqlSession)`

- Executor

  > 具体的jdbc实现

## 实现说明

1. 示意图

![](images\示意图v1.0.png)

​	通过框架访问数据库时，首先通过SqlSession获取到Mapper实例，然后我们直接调用 mapp.method 即可。获取Mapper实例，SqlSession是通过Configuration实现的，mapper.method 执行SQL是通过 Executor实现。

1. 时序图

   ![](images\时序图v1.0.png)

   a. 首先通过SqlSession 获取Mapper，它是通过Configuration的下调用动态代理实现的

   b . Mapper执行方法时，会调用 MapperProxy 中 invoke 方法，在改方法中获取到，method 对应的SQL和参数，然后又回到SqlSession中

   c. 在SqlSession中调用 Executor 的具体实现

### 动态代理

![image.png](https://cdn.nlark.com/yuque/0/2019/png/253188/1575381109480-8ee4e55b-6e4e-4410-9ba3-0be67bca2cae.png)

​	正常代理模式的类图如上面所示，需要接口有实现类，然后代理类持有实现类的引用。所以此处Mapper的实现不是一个标准的动态代理。因为它没有实现类。

```java
SqlSession sqlSession = new DefaultSqlSession(new Configuration(), new SimpleExecutor());
AuthorMapper authorMapper = sqlSession.getMapper(AuthorMapper.class);
```

​	上述是我们获取Mapper实例的代码，既然我们的Mapper没有实现类，那么获取到的authorMapper是什么？

​	这里重点贴一下实现代码，首先我们有一个 MapperProxy 实现了 InvocationHandler , 然后 sqlSession.getMapper 方法实现是通过jdk的动态代理实现的。

`Proxy.newProxyInstance(this.getClass().getClassLoader(), new Class[]{clazz},
​            new MapperProxy(sqlSession))` 

MapperProxy:

```java
public class MapperProxy implements InvocationHandler {

    private SqlSession sqlSession;

    public MapperProxy(SqlSession sqlSession) {
        this.sqlSession = sqlSession;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        if (Objects.nonNull(method.getAnnotation(Select.class))) {
            String sql = getSql(method);
            return sqlSession.selectOne(sql, args[0]);
        }
        return method.invoke(this, args);
    }

    private String getSql(Method method) {
        MapperMethod mapperMethod = new MapperMethod(method);
        return mapperMethod.getSql();
    }
}
```

​	当我们调用 `authorMapper.selectByPrimaryKey` 方法时，会拦截到 Mapper.proxy的invoke方法中，我们在此方法，现获取到此方法对应的Sql语句，这里可以通过各种途径，mybatis 是通过解析xml拿到的，这里为了实现简单，我们是通过@Select注解拿到的。拿到Sql后通过Executor操作jdbc实现操作数据库。

























